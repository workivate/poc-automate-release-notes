# Name of the workflow
name: Release

# Run on every merge or commit to the main branch
on:
  push:
    branches:
      - main

# Automatically create a GitHub Release
jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"
    steps:
         - name: "Checkout repository"
           uses: actions/checkout@v2
           with:
            fetch-depth: 0

         - name: "Get package version"
           id: package-version
           uses: "martinbeentjes/npm-get-version-action@main"

         - name: Get latest tag (release)
           id: latest_tag
           shell: bash
           run: |
             echo "TAG=$(git tag -l '${{ steps.version_prefix.outputs.PREFIX }}*' | sort -V | tail -1)" >> $GITHUB_OUTPUT

         - name: "Compare the tag release value to the package.json version value, fail the workflow if the release is newer"
           id: compare-version
           shell: bash
           run: |
            if [ "$(printf '%s\n' "${{ steps.package-version.outputs.current-version }}" "${{ steps.latest_tag.outputs.TAG }}" | sort -V | head -n1)" = "${{ steps.package-version.outputs.current-version }}" ]; then
                echo "ERROR"
                exit 1
            else
                echo "OK"
                exit 0
            fi
             echo "Comparing [${{ steps.latest_tag.outputs.TAG }}] to [${{ steps.package-version.outputs.current-version }}]"

         - uses: "marvinpinto/action-automatic-releases@latest"
           with:
             path: aarondarwish/learn-github-actions
             repo_token: "${{ secrets.GITHUB_TOKEN }}"
             automatic_release_tag: ${{ steps.package-version.outputs.current-version}} 
             prerelease: false

